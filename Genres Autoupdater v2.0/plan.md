## ПЛАН РОБОТИ ПРОЕКТУ "Genres Autoupdater v2.0"

**Загальна мета:** Виправити та вдосконалити Python-скрипт (`music_genre_updater.py`), який автоматично аналізує медіатеку в додатку "Музика" на macOS, очищує метадані та визначає/оновлює рік оригінального випуску для кожного альбому.

**Поточне ключове завдання:** Виправити логіку у функції `_get_scored_releases_from_musicbrainz` у файлі `services/external_api_service.py` для забезпечення максимально ефективного та точного пошуку релізів, мінімізуючи помилкові спрацьовування та зайві попередження в логах, особливо "Attempt 1 (Precise Search) failed".

### Етапи та завдання

1. **Аналіз поточного стану (після змін користувача від 11.06.2025):**
    * **Статус:** Користувач вніс зміни до `_get_scored_releases_from_musicbrainz`, додавши багаторівневий пошук та покращену фільтрацію.
    * **Проблема:** Логи показують, що перший, найточніший запит (наприклад, `artist:"katatonia" AND releasegroup:"brave murder day"`) все ще часто не повертає результатів, змушуючи скрипт використовувати менш надійні запасні варіанти.

2. **Крок 1: Ізоляція проблеми з першим точним запитом до MusicBrainz:**
    * **Дія:** Уважно вивчити URL, що генерується для "Attempt 1 (Precise Search)".
        * Приклад URL з логів (для `artist:"katatonia" AND releasegroup:"brave murder day"`):
          `https://musicbrainz.org/ws/2/release-group/?fmt=json&limit=10&query=artist%3A%22katatonia%22%20AND%20releasegroup%3A%22brave%20murder%20day%22`
    * **Дія:** Рекомендувати користувачеві протестувати цю URL-адресу безпосередньо в браузері або за допомогою `curl`.
    * **Мета:** Визначити, чи проблема полягає в:
        * a) самому запиті (MusicBrainz не знаходить відповідностей за такими точними критеріями).
        * b) способі, яким скрипт надсилає запит або обробляє відповідь (наприклад, проблема в `_make_api_request` або асинхронній обробці).
    * **Причина:** Локалізувати джерело невдачі точного пошуку.

3. **Крок 2: Коригування на основі результатів аналізу (за потреби):**
    * **Сценарій А (URL працює в браузері, але не в скрипті):**
        * **Дія:** Детально перевірити функцію `_make_api_request` та пов'язаний асинхронний код. Звернути увагу на обробку заголовків, таймаутів, помилок HTTP.
    * **Сценарій Б (URL не працює навіть у браузері):**
        * **Дія:** Розглянути модифікацію функції `escape_lucene` або структури `primary_query`. Можливо, поточне екранування або строгість запиту є надмірними для деяких випадків.
        * **Дія:** Дослідити, чи не впливає регіон виконавця (`artist_region`) на результати пошуку MusicBrainz і чи потрібно його враховувати в запиті.
    * **Причина:** Виправити основну причину невдачі першої спроби пошуку.

4. **Крок 3: Оцінка та доопрацювання фільтрації для запасних варіантів пошуку:**
    * **Дія:** Перевірити логіку фільтрації, яку додав користувач (блок `if not (rg_data1 and rg_data1.get("count", 0) > 0):`).
    * **Мета:** Переконатися, що фільтрація за виконавцем надійно працює для результатів, отриманих через менш точні запити (Attempt 2, Attempt 3), і відкидає нерелевантні альбоми (наприклад, збірки "Various Artists").
    * **Причина:** Забезпечити точність результатів, навіть якщо доводиться використовувати запасні варіанти пошуку.

5. **Крок 4: Комплексне тестування:**
    * **Дія:** Запустити скрипт з очищеним кешем на тестовому наборі виконавців (наприклад, "Katatonia" та інші проблемні випадки, якщо такі відомі).
    * **Аналіз логів:**
        * Зменшення або відсутність попереджень `Attempt 1 (Precise Search) failed...`.
        * Коректність знайдених років для альбомів.
        * Відсутність нових помилок або регресій.
    * **Причина:** Підтвердити, що всі зміни працюють коректно та ефективно.

6. **Крок 5: Рефакторинг та оптимізація (за потреби):**
    * **Дія:** Після досягнення стабільної роботи, переглянути код функції `_get_scored_releases_from_musicbrainz` на предмет можливих покращень читабельності, продуктивності або обробки виняткових ситуацій.
    * **Причина:** Забезпечити високу якість та надійність коду.

Цей план буде збережено у `plan.md`.
